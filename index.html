<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inserimento attività su Google Sheet</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; max-width:800px; margin:24px auto; padding:16px; }
    label { display:block; margin-bottom:8px; }
    input, select, button { font-size:1rem; padding:8px; margin-top:4px; width:100%; box-sizing:border-box; }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    .result { margin-top:12px; padding:10px; border-radius:6px; background:#f3f4f6; }
    .hint { font-size:0.9rem; color:#555; margin-top:6px; }
  </style>
</head>
<body>
  <h1>Inserisci attività</h1>
  <p class="hint">Compila i campi e premi <strong>Invia</strong> per salvare sul Google Sheet tramite la Web App.</p>

  <form id="activityForm">
    <label>Data
      <input type="date" id="date" required />
    </label>

    <div class="row">
      <div>
        <label>Commessa (5 cifre)
          <input type="text" id="commessa" pattern="\d{5}" title="5 cifre" required />
        </label>
      </div>
      <div>
        <label>Sotto commessa (2 cifre o 1 lettera)
          <input type="text" id="sottocommessa" pattern="(\d{2}|[A-Za-z])" title="2 cifre o 1 lettera" required />
        </label>
      </div>
    </div>

    <label>Descrittivo
      <input type="text" id="descrittivo" maxlength="200" required />
    </label>

    <div class="row">
      <div>
        <label>Ore
          <input type="number" id="ore" min="0" step="0.25" required />
        </label>
      </div>
      <div>
        <label>Trasferta
          <select id="trasferta" required>
            <option value="">-- seleziona --</option>
            <option value="si">Si</option>
            <option value="no">No</option>
          </select>
        </label>
      </div>
    </div>

    <label>Luogo (es. Italia, Estero)
      <input type="text" id="luogo" required />
    </label>

    <div style="margin-top:12px;">
      <button type="submit">Invia</button>
    </div>
  </form>

  <div id="result" class="result" style="display:none;"></div>

  <script>
    // Inserisci qui la URL della tua Web App di Google Apps Script
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwB_IK0r1B-OenRE0pPay8XtaQKsY_MNeVBHqTQsvUQ-WYtAuG8XilJYqJkbWT7pytT/exec";

    const form = document.getElementById('activityForm');
    const resultEl = document.getElementById('result');

    function showResult(msg, ok=true) {
      resultEl.style.display = 'block';
      resultEl.textContent = msg;
      resultEl.style.background = ok ? '#e6ffed' : '#ffe9e9';
      resultEl.style.border = ok ? '1px solid #84d29d' : '1px solid #f2a1a1';
    }

    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();

      // Prendi i valori dal form
      const rawDate = document.getElementById('date').value; // yyyy-MM-dd
      if(!rawDate){ showResult('Seleziona una data.', false); return; }
      const parts = rawDate.split('-');
      const date = parts[2] + '/' + parts[1] + '/' + parts[0]; // dd/MM/yyyy

      const commessa = document.getElementById('commessa').value.trim();
      const sottocommessa = document.getElementById('sottocommessa').value.trim();
      const descrittivo = document.getElementById('descrittivo').value.trim();
      const ore = document.getElementById('ore').value;
      const trasferta = document.getElementById('trasferta').value;
      const luogo = document.getElementById('luogo').value.trim();

      // Validazioni base
      if(!/^\d{5}$/.test(commessa)){ showResult('Commessa deve essere 5 cifre.', false); return; }
      if(!/^(\d{2}|[A-Za-z])$/.test(sottocommessa)){ showResult('Sotto commessa: 2 cifre o 1 lettera.', false); return; }
      if(descrittivo.length===0){ showResult('Inserisci il descrittivo.', false); return; }
      if(ore==='' || Number(ore)<0){ showResult('Inserisci un numero di ore valido.', false); return; }
      if(trasferta===''){ showResult('Seleziona trasferta.', false); return; }
      if(luogo.length===0){ showResult('Inserisci il luogo.', false); return; }

      const payload = { date, commessa, sottocommessa, descrittivo, ore, trasferta, luogo };
      showResult('Invio in corso... Attendere.', true);

      try {
        const resp = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });

        if(!resp.ok){
          const txt = await resp.text();
          showResult('Errore dal server: ' + txt, false);
          return;
        }

        const text = await resp.text();
        showResult('Risposta: ' + text, true);

        // Facoltativo: pulire il form dopo l'invio
        form.reset();
      } catch(err){
        showResult('Errore di connessione: ' + err.message, false);
      }
    });
  </script>
</body>
</html>
